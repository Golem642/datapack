execute store success score bool test as @e[type=item,nbt={Item:{id:"minecraft:compass"}}] at @s if data entity @s Item.tag.LodestonePos if block ~ ~-1 ~ minecraft:respawn_anchor if entity @e[type=item,nbt={Item:{id:"minecraft:ender_pearl",Count:1b}},distance=0..0.5] run setblock ~ ~-1 ~ minecraft:end_gateway{ExactTeleport:1b,Age:-9223372036854775808L}
execute if score bool test matches 1 run execute store success score bool test as @e[type=item,nbt={Item:{id:"minecraft:compass"}}] at @s if data entity @s Item.tag.LodestonePos if block ~ ~-1 ~ minecraft:end_gateway if entity @e[type=item,nbt={Item:{id:"minecraft:ender_pearl",Count:1b}},distance=0..0.5] run data modify block ~ ~-1 ~ ExitPortal set from entity @s Item.tag.LodestonePos
execute if score bool test matches 1 run execute as @e[type=item,nbt={Item:{id:"minecraft:compass"}}] at @s if data entity @s Item.tag.LodestonePos if block ~ ~-1 ~ minecraft:end_gateway run kill @e[type=item,nbt={Item:{id:"minecraft:ender_pearl",Count:1b}},distance=0..0.5,limit=1]
execute as @e[type=minecraft:falling_block,nbt={BlockState:{Name:"minecraft:anvil"}}] at @s if block ~ ~-1 ~ minecraft:end_gateway{ExactTeleport:1b} run setblock ~ ~-1 ~ air
execute as @a[nbt={PortalCooldown:9}] at @s unless block ~00 ~1 ~00 minecraft:nether_portal unless block ~-1 ~1 ~00 minecraft:nether_portal unless block ~01 ~1 ~00 minecraft:nether_portal unless block ~00 ~1 ~-1 minecraft:nether_portal unless block ~00 ~1 ~01 minecraft:nether_portal run playsound minecraft:entity.enderman.teleport player @a ~ ~ ~ 1 1 0